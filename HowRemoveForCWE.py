import math
import csv
import pandas as pd


data = pd.read_csv('RepositoryeCommit.csv', sep='|',
                 names=['CVE', 'summary', 'CWE', 'Published date', 'Last update', 'CVSS', 'Impact confidentiality',
                        'Impact integrity', 'Impact availability', 'Product name', 'Vendor name', 'Url_repository',
                        'Commit_id', 'Url_trackers'], skiprows=1)

hr=pd.read_csv('HowRemoveResults.csv', sep='|',
                 names=['CVE', 'CWE', 'repo', 'files', 'additions', 'deletions',
                        'how'],skiprows=1)

cwe=pd.read_csv('CWE.csv', sep='|',names=['cwe'],skiprows=1)



def addCWE():
    for index,row in hr.iterrows():
            #print(index)
            if type(row[1]) is not str:
                #print(row[1])
                x = float(row[1])
                if math.isnan(x):
                    #print("is nan")
                    for rowRC in data.iterrows():
                        #print("nel ciclo")
                        #print(rowRC[1][0])
                        #print(row[0])
                        if rowRC[1][0]==row[0]:
                           #print("trovato")

                           hr.at[index,'CWE']=rowRC[1][2]
                           break
                           #print("after",hr.at[index,2])
    hr.to_csv("HowRemoveResults.csv",sep="|")

howRemoveCwe={}

def divideForCWE():
    for row in hr.iterrows():
        if row[1][1] in howRemoveCwe:
            howRemoveCwe[row[1][1]].append(row[1][6])
        else:
            howRemoveCwe[row[1][1]]=[row[1][6]]

divideForCWE()
print(howRemoveCwe)

with open("HowRemoveForCWE.csv", "w", newline='') as hrForCweCsv:
    writer=csv.writer(hrForCweCsv,delimiter='|')
    writer.writerow(['cwe','name','count','howRemoved'])
    for k,v in howRemoveCwe.items():
        print(k)
        name=''
        for row in cwe.iterrows():
            #print(row[0][0])
            if row[0][0]==k:
                print("trovato")
                name=row[0][1]

                print("fatto")
                break
        writer.writerow([k, name, len(v), ";".join(str(p) for p in v)])
